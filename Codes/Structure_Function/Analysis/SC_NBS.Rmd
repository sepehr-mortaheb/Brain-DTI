```{r}
library(lme4)
library(tidyverse)
library(igraph)
library(pbapply)  # for progress bar
```

```{r}
# -----------------------------
# STEP 1: Load and prepare data
# -----------------------------

res_dir = '/Users/sepehrmortaheb/MyDrive/Academic/LEIA/Projects/BRAIN-DTI/Cosmonauts_StructFunc/Analysis/results/SC/'
df <- read.xlsx(
  file.path(
    res_dir, 
    'SC_Cosmonauts_SCH100.xlsx'
  )
)

# subjects to exclude
excluded_subjects <- c(
  "sub-cosmonaut13", 
  "sub-cosmonaut15", 
  "sub-cosmonaut16",
  "sub-cosmonaut26"
) 

df <- df %>%
  filter(
    flight == 'f1', 
    time %in% c("pre2", "post"),
    !subject %in% excluded_subjects
  ) %>%
  mutate(
    time = factor(
      time, 
      levels = c("pre2", "post")
    ),
    log_val = log(val+1e-5, base=2)
  )

```

```{r}
# -----------------------------
# STEP 2: Compute LMM t-values
# -----------------------------
edges <- unique(df$edge)

get_lmm_tvalue <- function(edge_name) {
  data_edge <- df %>% filter(edge == edge_name)
  if (length(unique(data_edge$subject)) < 5) return(NA)
  model <- try(lmer(log_val ~ time + (1 | subject), data = data_edge), silent = TRUE)
  if (inherits(model, "try-error")) return(NA)
  coef <- summary(model)$coefficients
  if ("timepost" %in% rownames(coef)) return(coef["timepost", "t value"]) else return(NA)
}

cat("Fitting LMMs...\n")
t_values <- pbsapply(edges, get_lmm_tvalue)
names(t_values) <- edges

# Threshold (e.g., |t| > 2.0)
t_thresh <- 2.0
supra_edges <- names(t_values)[abs(t_values) > t_thresh]

```

```{r}
# -----------------------------
# STEP 3: Build observed graph
# -----------------------------
edge_list <- supra_edges %>%
  str_split("-", simplify = TRUE) %>%
  as.data.frame() %>%
  rename(node1 = V1, node2 = V2)

g_obs <- graph_from_data_frame(edge_list, directed = FALSE)
obs_components <- components(g_obs)
obs_max_size <- max(obs_components$csize)

```

```{r}
# -----------------------------
# STEP 4: Permutation loop
# -----------------------------
n_perm <- 1000
perm_max_sizes <- numeric(n_perm)

subject_ids <- unique(df$subject)

cat("Running permutations...\n")
for (i in 1:n_perm) {
  # Flip pre/post labels randomly within subject
  df_perm <- df %>%
    group_by(subject) %>%
    mutate(time = sample(time)) %>%
    ungroup()

  # Compute t-values per edge
  perm_tvals <- pbsapply(edges, function(edge_name) {
    data_edge <- df_perm %>% filter(edge == edge_name)
    model <- try(lmer(log_val ~ time + (1 | subject), data = data_edge), silent = TRUE)
    if (inherits(model, "try-error")) return(NA)
    coef <- summary(model)$coefficients
    if ("timepost" %in% rownames(coef)) return(coef["timepost", "t value"]) else return(NA)
  })

  # Threshold and build graph
  perm_edges <- names(perm_tvals)[abs(perm_tvals) > t_thresh]
  perm_list <- perm_edges %>%
    str_split("-", simplify = TRUE) %>%
    as.data.frame() %>%
    rename(node1 = V1, node2 = V2)

  g_perm <- tryCatch(graph_from_data_frame(perm_list, directed = FALSE), error = function(e) NULL)
  if (!is.null(g_perm)) {
    obs_membership <- obs_components$membership
    obs_ids <- unique(obs_membership)
    obs_edge_counts <- sapply(obs_ids, function(cid) {
      nodes_in_comp <- names(obs_membership[obs_membership == cid])
      subg <- induced_subgraph(g_obs, vids = nodes_in_comp)
      ecount(subg)
    })
    perm_max_sizes[i] <- max(obs_edge_counts)
  } else {
    perm_max_sizes[i] <- 0
  }
}

```

```{r}
# -----------------------------
# STEP 5: Compute corrected p-value
# -----------------------------
p_nbs <- mean(perm_max_sizes >= obs_max_size)
cat("Observed component size:", obs_max_size, "\n")
cat("NBS-corrected p-value:", p_nbs, "\n")


